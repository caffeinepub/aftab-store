{
  "schemaVersion": "1.0.0",
  "projectStateVersion": 3,
  "summary": "Fix ProductDetailModal double-click-to-close by correcting history.pushState/popstate handling so close button, overlay click, ESC, and browser back all close consistently.",
  "architectural_notes": [
    "ProductDetailModal should push a history state when opened and close via popstate; use refs (e.g., isClosingRef, historyPushedRef) to prevent race conditions and double-close/double-click behavior."
  ],
  "known_issues": [
    "ProductDetailModal currently requires double-click on close button due to history.back()/popstate conflict causing inconsistent close behavior."
  ],
  "isFixRequest": true,
  "existing_features": [
    {
      "id": "feature-update-frontend-src-components-productdetailmodal-tsx-history-management-so-the-modal-closes-on-a-single-click-of-the-close-button-by-properly-coordinating-history-pushstate-window-history-back-and-the-popstate-listener-using-refs-to-avoid-race-conditions-specifically-a-when-open-becomes-true-push-a-history-state-once-and-set-a-historypushedref-flag-b-implement-a-unified-close-handler-guarded-by-isclosingref-that-calls-window-history-back-only-when-a-modal-history-entry-was-pushed-otherwise-calls-onclose-directly-and-does-not-clear-historypushedref-before-triggering-back-c-add-a-popstate-listener-that-while-the-modal-is-open-clears-historypushedref-and-calls-onclose-so-browser-back-and-the-close-button-s-history-back-reliably-closes-the-modal-in-one-action",
      "title": "Update `frontend/src/components/ProductDetailModal.tsx` history management so the modal closes on a single click of the close button by properly coordinating `history.pushState`, `window.history.back()`, and the `popstate` listener using refs to avoid race conditions. Specifically: (a) when `open` becomes true, push a history state once and set a `historyPushedRef` flag; (b) implement a unified close handler guarded by `isClosingRef` that calls `window.history.back()` only when a modal history entry was pushed (otherwise calls `onClose()` directly) and does not clear `historyPushedRef` before triggering `back()`; (c) add a `popstate` listener that, while the modal is open, clears `historyPushedRef` and calls `onClose()` so browser back (and the close buttonâ€™s `history.back()`) reliably closes the modal in one action.",
      "reqIds": [
        "REQ-1"
      ],
      "version": 1
    }
  ],
  "new_feature_requests": [
    {
      "id": "AR-1",
      "summary": "Fix ProductDetailModal history management so close button closes on single click while preserving overlay/ESC/back-button behavior (pushState + popstate with refs to avoid race conditions).",
      "reqIds": [],
      "status": "pending"
    }
  ],
  "projectName": "Fix ProductDetailModal double-click close by correcting history/popstate handling",
  "clarification_mode": "instant",
  "clarification_rounds": 0
}